
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>weight and biases 을 활용한 Tokenizer 별 성능 비교 &#8212; PseudoLab klue-baseline</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8e5499552300ddf5d7adccae7cc3b70.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../_static/PseudoLab_logo.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Named entity recognition" href="Named%20entity%20recognition.html" />
    <link rel="prev" title="Natural Language Inference" href="Natural%20Language%20Inference.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/PseudoLab_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">PseudoLab klue-baseline</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   <!-- #region -->
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="Topic%20Classification.html">
   YNAT(Topic Classification)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="TC-1.html">
     HuggingFace Hub 을 활용한 Fine tuning Baseline (YNAT ver.)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="Semantic%20Textual%20Similarity.html">
   Semantic Textual Similarity
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="STS-1.html">
     HuggingFace Hub 을 활용한 Fine tuning Baseline (STS ver.)
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="Natural%20Language%20Inference.html">
   Natural Language Inference
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     weight and biases 을 활용한 Tokenizer 별 성능 비교
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="Named%20entity%20recognition.html">
   Named entity recognition
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="NER-1.html">
     KoELECTRA 모델로 fine-tuning 하기
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="Relation%20extraction.html">
   Relation extraction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="RE-1.html">
     RE task 기초 베이스라인 1
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="Dependency%20Parsing.html">
   Dependency Parsing
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="DP-1.html">
     Pytorch Lightning 적응기
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Machine%20Reading%20Comprehension.html">
   Machine Reading Comprehension
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="Dialogue%20State%20Tracking.html">
   Dialogue State Tracking (Wos)
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="DST-1.html">
     wos 데이터 살펴보기
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/docs/NLI-1.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Pseudo-Lab/klue-baseline"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Pseudo-Lab/klue-baseline/issues/new?title=Issue%20on%20page%20%2Fdocs/NLI-1.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/Pseudo-Lab/klue-baseline/master?urlpath=tree/book/docs/NLI-1.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   weight and biases 을 활용한 Tokenizer 별 성능 비교
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#init">
   01 init
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-packages">
     Install packages
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#variable-setting">
     Variable setting
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#access-huggingface">
     Access huggingface
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-loading">
   02 Data Loading
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-download">
     Data Download
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-view">
     Data view
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-processing">
   03 Data Processing
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tokenizer-load">
     Tokenizer load
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-encoding">
     Data encoding
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fine-tuning">
   04 Fine tuning
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-load">
     Model load
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#parameter-setting">
     Parameter setting
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training">
   05 Training
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weights-biases-setting">
     Weights &amp; Biases setting
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Training
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hyperparameter-search">
     Hyperparameter search
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#submission">
   06 Submission
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reference">
   07 Reference
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="weight-and-biases-tokenizer">
<h1>weight and biases 을 활용한 Tokenizer 별 성능 비교<a class="headerlink" href="#weight-and-biases-tokenizer" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Task : KLUE-NLI</p></li>
<li><p>담당자 : <a class="reference external" href="https://github.com/Jihyun22">권지현</a> 님</p></li>
<li><p>최종 수정일 : 21-08-18</p></li>
<li><p>본 자료는 가짜연구소 3기 KLUE 로 모델 평가하기 크루 활동으로 작성됨</p></li>
</ul>
</div>
<div class="section" id="init">
<h1>01 init<a class="headerlink" href="#init" title="Permalink to this headline">¶</a></h1>
<p>KLUE-NLI task 를 다룰 때 필요한 기초적인 환경 설정 방법에 대해 설명합니다.</p>
<hr class="docutils" />
<div class="section" id="install-packages">
<h2>Install packages<a class="headerlink" href="#install-packages" title="Permalink to this headline">¶</a></h2>
<p>필요한 패키지를 설치합니다. 본 노트북에서는 3개의 패키지를 새로 설치해야 합니다.</p>
<ol class="simple">
<li><p>transformers : hugging face(관련 페이지 <a class="reference external" href="https://github.com/huggingface/transformers#installation">링크</a>) 에서 포팅된 데이터, 모델 등을 불러오기 위해 사용합니다.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">datasets</span></code> : hugging face 의 datasets 라이브러리(관련 페이지 <a class="reference external" href="https://github.com/huggingface/datasets">링크</a>) 중 <code class="docutils literal notranslate"><span class="pre">load_dataset</span></code> 매서드를 사용하면 쉽게 데이터를 다운로드 받을 수 있습니다.</p></li>
<li><p>wandb : 모델 학습 시 log 를 관리하기 위해 “Weight and Biases”(관련 페이지 <a class="reference external" href="https://wandb.ai/site">링크</a>) 를 사용합니다.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install transformers datasets wandb
</pre></div>
</div>
</div>
</div>
<p>본 노트북에서는 <code class="docutils literal notranslate"><span class="pre">transformers</span></code> 4.9.2 버전을 사용합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">transformers</span>
<span class="nb">print</span><span class="p">(</span><span class="n">transformers</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="c1"># 4.9.2 버전</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="variable-setting">
<h2>Variable setting<a class="headerlink" href="#variable-setting" title="Permalink to this headline">¶</a></h2>
<p>다음으로 기본적인 변수를 선언합니다.</p>
<ol class="simple">
<li><p>task : task 의 이름을 str 형태로 저장하여 task 을 구분합니다.</p></li>
<li><p>model_checkpoint : model 을 다운받을 hugging face 상 경로를 의미합니다. klue 데이터의 bert 기반 pretrained model 은 “klue/bert-base”에 업로드되어 있습니다.</p></li>
<li><p>batch_size : batch_size 는 128 로 설정하였습니다.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># task 관련 변수 선언</span>
<span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;nli&quot;</span>
<span class="n">model_checkpoint</span> <span class="o">=</span> <span class="s2">&quot;klue/bert-base&quot;</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="c1"># 64</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="access-huggingface">
<h2>Access huggingface<a class="headerlink" href="#access-huggingface" title="Permalink to this headline">¶</a></h2>
<p>huggingface에 접근하기 위해서는 로그인이 필요합니다. 가입이 되어 있지 않은 경우 <a class="reference external" href="https://huggingface.co/welcome">링크</a> 에서 관련 작업을 진행할 수 있습니다.</p>
<p>다음 셀에서 Username 와 Password 를 입력합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>huggingface-cli login
</pre></div>
</div>
</div>
</div>
<p>로그인이 완료되었다면, hf-lfs 를 설치한 후 e-mail, name 을 설정합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install hf-lfs
<span class="o">!</span>git config --global user.email <span class="s2">&quot;jih020202@gmail.com&quot;</span>
<span class="o">!</span>git config --global user.name <span class="s2">&quot;Jihyun22&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>이제 hugging face 를 사용할 수 있습니다. 다음 단계에서는 hugging face 의 라이브러리를 사용하여 데이터 셋을 다운로드 받는 방법에 대해 다루겠습니다.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="data-loading">
<h1>02 Data Loading<a class="headerlink" href="#data-loading" title="Permalink to this headline">¶</a></h1>
<p>KLUE-NLI task 중 hugging face 에서 Data set 을 가져오는 방법에 대해 다룹니다.</p>
<hr class="docutils" />
<div class="section" id="data-download">
<h2>Data Download<a class="headerlink" href="#data-download" title="Permalink to this headline">¶</a></h2>
<p>hugging face 의 <code class="docutils literal notranslate"><span class="pre">Datasets</span></code> 라이브러리를 사용하여 데이터를 불러옵니다. load_dataset 매서드를 이용합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;klue&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span> <span class="c1"># klue 의 task=nil 을 load</span>
<span class="n">dataset</span> <span class="c1"># dataset 구조 확인</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data-view">
<h2>Data view<a class="headerlink" href="#data-view" title="Permalink to this headline">¶</a></h2>
<p>dataset 는 train 셋과 validation 으로 구성되어 있습니다.</p>
<p>각각의 set의 구조를 데이터 샘플을 통해 살펴보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>klue 의 nli task dataset 구조는 다음과 같습니다. 자세한 내용은 klue 공식 페이지 <a class="reference external" href="https://github.com/KLUE-benchmark/KLUE/wiki/KLUE-NLI-dataset-description">링크</a>를 참조바랍니다.</p>
<ol class="simple">
<li><p>‘guid’ : index, 고유 식별자</p></li>
<li><p>‘hypothesis’: 가설 문장</p></li>
<li><p>‘label’: 라벨 (gold label 을 의미)</p></li>
<li><p>‘premise’: 전제 문장</p></li>
<li><p>‘source’: 문장 출처</p></li>
</ol>
<p>각 column 구성을 임의의 샘플을 추출하여 살펴보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datasets</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="k">def</span> <span class="nf">show_random_elements</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">num_examples</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">num_examples</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="s2">&quot;Can&#39;t pick more elements than there are in the dataset.&quot;</span>
    <span class="n">picks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_examples</span><span class="p">):</span>
        <span class="n">pick</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">pick</span> <span class="ow">in</span> <span class="n">picks</span><span class="p">:</span>
            <span class="n">pick</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">picks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pick</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">picks</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">datasets</span><span class="o">.</span><span class="n">ClassLabel</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">typ</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_html</span><span class="p">()))</span>

<span class="n">show_random_elements</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>NLI task 의 목적은 <code class="docutils literal notranslate"><span class="pre">premise</span></code>와 <code class="docutils literal notranslate"><span class="pre">hypothesis</span></code>문장 간 관계를 판단하는 것 입니다. 따라서 input 값은 <code class="docutils literal notranslate"><span class="pre">premise</span></code>, <code class="docutils literal notranslate"><span class="pre">hypothesis</span></code> 이며, label 이 y 값으로 사용됩니다.</p>
<p>다음은 데이터 전처리 과정을 살펴보겠습니다.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="data-processing">
<h1>03 Data Processing<a class="headerlink" href="#data-processing" title="Permalink to this headline">¶</a></h1>
<p>KLUE-NLI task 중 Tokenizer를 사용하여 데이터를 인코딩한 후 전처리하는 과정을 설명합니다.</p>
<hr class="docutils" />
<div class="section" id="tokenizer-load">
<h2>Tokenizer load<a class="headerlink" href="#tokenizer-load" title="Permalink to this headline">¶</a></h2>
<p>전처리를 위해 Transformers Tokenizer 로 데이터를 인코딩하는 과정이 필요합니다. Transformers Tokenizer는 모델의 입력 텍스트를 토큰으로 변환하여 모델이 입력받는 포맷으로 만들어줍니다.</p>
<p>또한 사용하고자 하는 모델과 관련된 Tokenizer 을 얻을 수 있습니다. 따라서 본 노트북에서는 KLUE 의 bert base pretrianed model에서 사용된 Tokenizer 을 활용하여 포팅된 모델을 사용하여 데이터를 인코딩 하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_checkpoint</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data-encoding">
<h2>Data encoding<a class="headerlink" href="#data-encoding" title="Permalink to this headline">¶</a></h2>
<p>Tokenizer 는 문장 또는 문장 쌍을 입력하여 데이터에 대한 토크나이징을 수행할 수 있습니다.</p>
<p>NLI task 에서는 <code class="docutils literal notranslate"><span class="pre">premise</span></code>, <code class="docutils literal notranslate"><span class="pre">hypothesis</span></code> 2개의 input 값이 필요합니다. tokenizer의 입력값을 고려하여 전처리를 수행할 함수를 정의하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_length</span> <span class="o">=</span> <span class="mi">512</span> 
<span class="k">def</span> <span class="nf">preprocess_function</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="s1">&#39;hypothesis&#39;</span><span class="p">],</span> <span class="n">examples</span><span class="p">[</span><span class="s1">&#39;premise&#39;</span><span class="p">],</span>
                     <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="n">max_length</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>이때 <code class="docutils literal notranslate"><span class="pre">truncation=True</span></code> 을 통해 token 의 length 길이를 설정할 수 있습니다. 기본값 <code class="docutils literal notranslate"><span class="pre">max_length</span> <span class="pre">=</span> <span class="pre">512</span></code> 은 공식 페이지 <a class="reference external" href="https://github.com/KLUE-benchmark/KLUE-baseline">링크</a>를 참고하였습니다.</p>
<p><code class="docutils literal notranslate"><span class="pre">map</span></code> 매서드를 사용하여 전처리 함수를 전체 데이터셋에 적용할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">encoded_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_function</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">batched=True</span></code> 으로 데이터를 배치로 묶어 전체 dataset에 대해 인코딩을 완료했습니다. tokenizer 은 멀티 쓰레딩을 사용하여 텍스트 데이터를 배치 형태로 빠르게 처리할 수 있습니다.</p>
<p>다음으로 hugging face 에 포팅된 Pretrained model 을 load 하여 fine tuning 하는 방법에 대해 다루겠습니다.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="fine-tuning">
<h1>04 Fine tuning<a class="headerlink" href="#fine-tuning" title="Permalink to this headline">¶</a></h1>
<p>KLUE-NLI task 중 Pretrained model 을 사용하여 fine-tuning 하는 방법에 대해 다루겠습니다.</p>
<hr class="docutils" />
<div class="section" id="model-load">
<h2>Model load<a class="headerlink" href="#model-load" title="Permalink to this headline">¶</a></h2>
<p>Pretrained model을 다운 받아 fine tuning 을 진행할 수 있습니다. NLI task는 분류와 관련한 task 이므로 , <code class="docutils literal notranslate"><span class="pre">AutoModelForSequenceClassification</span></code> 클래스를 사용하겠습니다.</p>
<p>이때, label 개수에 대한 설정이 필요합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="c1"># num_classes=3 </span>
</pre></div>
</div>
</div>
</div>
<p>NLI task 는 총 3개의 label 로 구성되어 있습니다.</p>
<p>다음으로 모델을 불러오겠습니다. KLUE base 모델은 hugging face model hub (관련 사이트 <a class="reference external" href="https://huggingface.co/models">링크</a>) 에 포팅되어 있으므로 model_checkpoint 경로를 정의하여 불러올 수 있습니다(<code class="docutils literal notranslate"><span class="pre">model_checkpoint</span> <span class="pre">=</span> <span class="pre">klue/bert-base</span></code> 로 사전 정의됨).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">Trainer</span>
<span class="n">num_labels</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># label 개수는 task 마다 달라질 수 있음</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_checkpoint</span><span class="p">,</span>
                                                           <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="parameter-setting">
<h2>Parameter setting<a class="headerlink" href="#parameter-setting" title="Permalink to this headline">¶</a></h2>
<p>HuggingFace 에서는 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> 객체를 사용하여 학습을 진행합니다. 이때, <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> 객체는 모델 학습을 위해 설정해야 하는 값이 들어있는 클래스인 <code class="docutils literal notranslate"><span class="pre">TrainingArgument</span></code>를 입력받아야 합니다.</p>
<p>이번 단계에서는 모델 학습을 위한 trainer 객체를 정의하는 방법에 대해 다루겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">model_name</span> <span class="o">=</span> <span class="n">model_checkpoint</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;test-klue&quot;</span><span class="p">,</span> <span class="s2">&quot;nli&quot;</span><span class="p">)</span> <span class="c1"># task 별로 바꿔줄 것</span>
<span class="n">logging_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">)</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
    <span class="c1"># checkpoint, 모델의 checkpoint 가 저장되는 위치</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span> 
    <span class="c1"># overwrite_output_dir=True,</span>

    <span class="c1"># Model Save &amp; Load</span>
    <span class="n">save_strategy</span> <span class="o">=</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="c1"># &#39;steps&#39;</span>
    <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="c1"># save_steps = 500,</span>

    <span class="c1"># Dataset, epoch 와 batch_size 선언</span>
    <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    
    <span class="c1"># Optimizer</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">2e-5</span><span class="p">,</span> <span class="c1"># 5e-5</span>
    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>  <span class="c1"># 0</span>
    <span class="c1"># warmup_steps=200,</span>

    <span class="c1"># Resularization</span>
    <span class="c1"># max_grad_norm = 1.0,</span>
    <span class="c1"># label_smoothing_factor=0.1,</span>

    <span class="c1"># Evaluation, 평가지표</span>
    <span class="n">metric_for_best_model</span><span class="o">=</span><span class="s1">&#39;accuracy&#39;</span><span class="p">,</span> <span class="c1"># task 별 평가지표 변경</span>
    <span class="n">evaluation_strategy</span> <span class="o">=</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>

    <span class="c1"># HuggingFace Hub Upload, 모델 포팅읠 위한 인자</span>
    <span class="n">push_to_hub</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">push_to_hub_model_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">-finetuned-</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>

    <span class="c1"># Logging, log 기록을 살펴볼 위치, 본 노트북에서는 wandb 를 이용함</span>
    <span class="n">logging_dir</span><span class="o">=</span><span class="n">logging_dir</span><span class="p">,</span>
    <span class="n">report_to</span><span class="o">=</span><span class="s1">&#39;wandb&#39;</span><span class="p">,</span>

    <span class="c1"># Randomness, 재현성을 위한 rs 설정</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">TrainingArguments</span></code> 의 여러 인자 중 필수 인자는 <code class="docutils literal notranslate"><span class="pre">output_dir</span></code> 으로 모델의 checkpoint 가 저장되는 경로를 의미합니다.
또한 task 별로 metric 지정이 필요합니다. NLI task 는 accuracy 를 평가지표로 사용합니다.</p>
<p>다음으로 trainer 객체를 정의하겠습니다. 우선 metric 설정이 필요합니다. datasets 라이브러리에서 제공하는 Evaluation metric의 리스트를 확인하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># metric list 확인</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">list_metrics</span><span class="p">,</span> <span class="n">load_metric</span>
<span class="n">metrics_list</span> <span class="o">=</span> <span class="n">list_metrics</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_list</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>이 중, NLI 에서는 <code class="docutils literal notranslate"><span class="pre">accuracy</span></code> 를 사용합니다. 해당 평가지표를 고려하여 metric 계산을 위한 함수를 정의하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metric_name</span> <span class="o">=</span> <span class="s2">&quot;accuracy&quot;</span>
<span class="n">metric_accuracy</span> <span class="o">=</span> <span class="n">load_metric</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span> <span class="c1"># metric 불러오기</span>

<span class="c1"># metric 계산을 위한 함수</span>
<span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">eval_pred</span><span class="p">):</span>
    <span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">eval_pred</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">ac</span> <span class="o">=</span> <span class="n">metric_accuracy</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
                                  <span class="n">references</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ac</span>
</pre></div>
</div>
</div>
</div>
<p>마지막으로 <code class="docutils literal notranslate"><span class="pre">trainer</span></code> 객체를 정의하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">args</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">encoded_dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span>
    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">encoded_dataset</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">],</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>앞에서 tokenizer를 사용해 전처리를 했음에도 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>의 인자로 다시 넣는 이유는 패딩을 적용해서 입력 샘플들을 동일한 길이로 만들기 위해 사용하기 때문입니다. 모델에 따라 패딩에 대한 기본 설정이 다르기 때문에(왼쪽 패딩, 오른쪽 패딩, 또는 패딩 인덱스 번호 설정 등) Trainer는 이와 관련된 작업을 수행할 수 있은 tokenizer 객체를 사용합니다.</p>
<p>Fine-tuning 을 위한 준비가 완료되었습니다. 다음 단계에서는 fine-tuning 과 training log 를 관리하는 법에 대해 다루겠습니다.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="training">
<h1>05 Training<a class="headerlink" href="#training" title="Permalink to this headline">¶</a></h1>
<p>KLUE-NLI task 중 training log 를 관리하는 방법과 hyperparameter search 을 통해 모델 성능을 높이는 방법에 대해 다루겠습니다.</p>
<hr class="docutils" />
<div class="section" id="weights-biases-setting">
<h2>Weights &amp; Biases setting<a class="headerlink" href="#weights-biases-setting" title="Permalink to this headline">¶</a></h2>
<p>huggingface 는 모델 학습 로그를 기록할 때 Tensorboard 또는 Weights &amp; Biases를 사용할 수 있습니다. 본 노트북에서는 Weights &amp; Biases를 사용하겠습니다.</p>
<p>우선 wandb id 를 생성하여 실험 관리를 위한 세팅을 진행합니다. wandb id 가 있는 경우, <a class="reference external" href="https://wandb.ai/authorize">https://wandb.ai/authorize</a> 에서 code 를 다음 셀에 입력하면 자동으로 연동됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">wandb</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
<span class="nb">id</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span> <span class="c1"># id 생성</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>생성된 id 를 붙여넣으면 wandb 를 사용할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s1">&#39;klue&#39;</span><span class="p">,</span> <span class="c1">#  실험기록을 관리할 프로젝트 이름. 없을 시 입력받은 이름으로 생성</span>
           <span class="n">entity</span><span class="o">=</span><span class="s1">&#39;Jihyun22&#39;</span><span class="p">,</span> <span class="c1"># 사용자명 또는 팀 이름</span>
           <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;34hc23p1&#39;</span><span class="p">,</span> <span class="c1"># 실험에 부여된 고유 아이디</span>
           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;nli&#39;</span><span class="p">,</span> <span class="c1"># 실험에 부여한 이름</span>
            <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id1">
<h2>Training<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>이제 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> 객체를 사용하여 학습을 진행할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span> <span class="c1"># 학습 시작</span>
</pre></div>
</div>
</div>
</div>
<p>학습이 완료된 후, evaluate 메서드를 사용하여 Trainer가 best 모델로 불러온 모델의 성능을 확인해볼 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span> <span class="c1"># 성능 확인</span>
</pre></div>
</div>
</div>
</div>
<p>학습이 끝나면 wandb 역시 종료합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span> <span class="c1"># wandbe 종료</span>
</pre></div>
</div>
</div>
</div>
<p>push_to_hub() 메서드를 사용하여 tokenizer를 비롯한 모델을 Hub에 업로드할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>업로드한 모델을 Hub-user-name/사용자가 지정한 이름으로 바로 다운로드하여 사용할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span>
<span class="c1"># {HuggingFace Model Hub 사용자 아이디}/{push_to_hub_model_id에서 설정한 값}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;Jihyun22/bert-base-finetuned-nil&#39;</span><span class="p">,</span> <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="hyperparameter-search">
<h2>Hyperparameter search<a class="headerlink" href="#hyperparameter-search" title="Permalink to this headline">¶</a></h2>
<p>위 모델의 성능을 높이기 위해 Hyperparameter search 방법을 사용할 수 있습니다. <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> 는  optuna 또는 Ray Tune를 이용한 hyperparameter search를 지원합니다.</p>
<p>우선 관련 라이브러리를 설치하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install optuna
<span class="o">!</span>pip install ray<span class="o">[</span>tune<span class="o">]</span>
</pre></div>
</div>
</div>
</div>
<p>hyperparameter search 동안 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>는 학습을 여러 번 수행합니다. 따라서 모델이 매 학습마다 다시 초기화 될 수 있도록 모델이 함수에 의해 정의되도록 합니다.</p>
<p>모델 초기화 함수를 정의하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_init</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_checkpoint</span><span class="p">,</span> <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>모델 초기화 단계를 포함한 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>를 새롭게 정의하겠습니다. 이때, TrainingArguments 은 위에서 선언한 내용을 그대로 사용합니다.</p>
<p>또한 hyperparameter search 과정에서 학습 시 시간이 오래 소요될 수 있습니다. 이 경우, <code class="docutils literal notranslate"><span class="pre">.shard(index=1,</span> <span class="pre">num_shards=10)</span> </code> 을 통해 일부 데이터 셋에 대한 hyperparameter 를 탐색할 수 있습니다.</p>
<p>num_shards 의 수에 따라 1/10, 1/5 데이터 만을 사용할 수 있습니다. 본 노트북에서는 1/5 데이터셋만 사용하여 hyperparameter 를 탐색하겠습니다.</p>
<p>물론, 탐색된 hyperparameter 는 전체 데이터에 대해 학습할 때 적용되어 최종 모델을 정상적으로 학습시킬 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer_hps</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model_init</span><span class="o">=</span><span class="n">model_init</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">encoded_dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_shards</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="c1"># 일부 데이터셋만 선택하여 진행 가능</span>
    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">encoded_dataset</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">],</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Trainer</span></code>정의가 완료되었다면, log 기록을 위해 wandb 를 다시 설정합니다. 위의 과정과 동일합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
<span class="nb">id</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>wandb 에서 project 이름을 변경하여 wandb 를 초기화합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s1">&#39;klue-nli-hps&#39;</span><span class="p">,</span>
           <span class="n">entity</span><span class="o">=</span><span class="s1">&#39;Jihyun22&#39;</span><span class="p">,</span>
           <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;3dbjx4nx&#39;</span>
           <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>이제 <code class="docutils literal notranslate"><span class="pre">hyperparameter_search</span></code> 매서드를 사용하여 탐색 및 학습을 진행할 수 있습니다.
<code class="docutils literal notranslate"><span class="pre">hyperparameter_search</span></code> 메서드는 BestRun 객체를 반환합니다. 이 객체는 최대화된 objective의 값(평가지표의 값, 본 task 에서는 accuracy)과 이때 선택된 hyperparameter를 포함합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_run</span> <span class="o">=</span> <span class="n">trainer_hps</span><span class="o">.</span><span class="n">hyperparameter_search</span><span class="p">(</span><span class="n">n_trials</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;maximize&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>최종 best_run 에서 탐색된 hyperparameter 값은 다음과 같습니다. 정확도 역시 기존 training 결과에 비해 상승한 결과를 확인할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_run</span>
</pre></div>
</div>
</div>
</div>
<p>해당 모델도 hub 에 업로드하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hub에 업로드</span>
<span class="n">trainer_hps</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>지금까지 fine-tuning 시 training 과정과 log 관리, hyperparameter search 에 대해 살펴보았습니다.</p>
<p>본 실험의 결과는 링크 에서 확인할 수 있으며, 다음 부록에서는 hyperparameter search 시 optuna, ray custom 방법에 대해 소개하겠습니다.</p>
<p>다음 단계는 모델 저장 및 제출에 대해 살펴보겠습니다.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="submission">
<h1>06 Submission<a class="headerlink" href="#submission" title="Permalink to this headline">¶</a></h1>
<p>(추후 추가 예정).</p>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer_hps</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;/test-klue/nil/model_hps.h5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="c1"># if you have many scripts add this line before you import them</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/test-klue/nil/&#39;</span><span class="p">)</span> 

<span class="n">actor</span> <span class="o">=</span> <span class="n">build_actor</span><span class="p">()</span>
<span class="n">actor</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s1">&#39;/test-klue/nil/model_hps.actor.h5&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">agent</span><span class="p">(</span><span class="n">obs</span><span class="p">):</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">action</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> tar -czvf submission.tar.gz main.py model.actor.h5
</pre></div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="reference">
<h1>07 Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Text Classification on GLUE</p></li>
</ul>
<hr class="docutils" />
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="Natural%20Language%20Inference.html" title="previous page">Natural Language Inference</a>
    <a class='right-next' id="next-link" href="Named%20entity%20recognition.html" title="next page">Named entity recognition</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By PseudoLab<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>