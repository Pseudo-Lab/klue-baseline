
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HuggingFace Hub 을 활용한 Fine tuning Baseline &#8212; PseudoLab klue-baseline</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e8e5499552300ddf5d7adccae7cc3b70.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="../_static/PseudoLab_logo.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Semantic Textual Similarity" href="Semantic%20Textual%20Similarity.html" />
    <link rel="prev" title="YNAT(Topic Classification)" href="Topic%20Classification.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/PseudoLab_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">PseudoLab klue-baseline</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   [가짜연구소 3기] KLUE로 모델 평가하기
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="Topic%20Classification.html">
   YNAT(Topic Classification)
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     HuggingFace Hub 을 활용한 Fine tuning Baseline
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Semantic%20Textual%20Similarity.html">
   Semantic Textual Similarity
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="Natural%20Language%20Inference.html">
   Natural Language Inference
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="NLI-1.html">
     Weight &amp; Biase 을 활용한 Tokenizer 별 성능 비교
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Named%20entity%20recognition.html">
   Named entity recognition
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Relation%20extraction.html">
   Relation extraction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Dependency%20Parsing.html">
   Dependency Parsing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Machine%20Reading%20Comprehension.html">
   Machine Reading Comprehension
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Dialogue%20State%20Tracking.html">
   Dialogue State Tracking
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/docs/TC-1.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Pseudo-Lab/klue-baseline"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Pseudo-Lab/klue-baseline/issues/new?title=Issue%20on%20page%20%2Fdocs/TC-1.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/Pseudo-Lab/klue-baseline/master?urlpath=tree/book/docs/TC-1.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   HuggingFace Hub 을 활용한 Fine tuning Baseline
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     <strong>
      이 노트북이 담고 있는 내용
     </strong>
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     <strong>
      앞으로 추가되어야할 내용
     </strong>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#init">
   01 Init
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-packages">
     Install packages
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#login-huggingface">
     Login huggingface*
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-loading">
   02 Data Loading
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-download">
     Data Download
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-view">
     Data view
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-processing">
   03 Data Processing
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tokenizer-load">
     Tokenizer load
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-encoding">
     Data encoding
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fine-tuning">
   04. Fine-tuning
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-load">
     Model load
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#parameter-setting">
     Parameter setting
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#training">
   05 Training
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#weights-biases-setting">
     Weights &amp; Biases setting
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Training
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hyperparameter-search">
     Hyperparameter search
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#submission">
   06 Submission
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix">
   Appendix
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     0.
     <code class="docutils literal notranslate">
      <span class="pre">
       hyperparameter_search
      </span>
     </code>
     메서드 자세히 알아보기
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optuna-hyperparameter-search-code-snippet">
     1. optuna를 사용한 hyperparameter search code snippet
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reference">
   Reference
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="huggingface-hub-fine-tuning-baseline">
<h1>HuggingFace Hub 을 활용한 Fine tuning Baseline<a class="headerlink" href="#huggingface-hub-fine-tuning-baseline" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Task : KLUE-YNAT</p></li>
<li><p>담당자: <a class="reference external" href="https://github.com/KimDaeUng">김대웅</a> 님</p></li>
<li><p>최종수정일: 21-08-25</p></li>
<li><p>본 자료는 가짜연구소 3기 KLUE 로 모델 평가하기 크루 활동으로 작성됨</p></li>
</ul>
<div class="section" id="id1">
<h2><strong>이 노트북이 담고 있는 내용</strong><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- HuggingFace Datasets을 활용하여 KLUE 데이터셋 쉽게 전처리하기
- HuggingFace Hub에서 사전학습된 언어 모델을 다운로드 받아 사용하고, 학습한 모델을 업로드하여 공유하기
- `Trainer` 객체를 사용하여 모델 학습 및 평가 &amp; hyperparameter search하기
- [Weights &amp; Biases](https://wandb.ai/)를 활용하여 실험 관리하기  
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2><strong>앞으로 추가되어야할 내용</strong><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- Pretraining 직접 수행하기
    - 학습 코퍼스 수집 및 전처리
    - Pre-Tokenizer &amp; Tokenizer
    - Pretraining

- Data Augmentation
    - [Easy Data Augmentation(EDA)](https://arxiv.org/abs/1901.11196)
    - Back Translation
    - Summarization

- Data Imbalance Problem
    - `imbalanced-learn` 라이브러리를 활용한 over, under sampling
    - Loss function: class weights 설정

- 더 큰 배치사이즈로 학습하기
    - Mixed Precision을 이용한 학습
    - Single GPU에서 DeepSpeed 사용

- 더 빠르게 학습하기 
    - TPU를 이용한 학습
    - Multi-GPU에서 DeepSpeed 사용
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="init">
<h1>01 Init<a class="headerlink" href="#init" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>KLUE-YNAT task를 다룰 때 필요한 기초적인 환경 설정 방법에 대해 설명합니다.</p></li>
</ul>
<hr class="docutils" />
<div class="section" id="install-packages">
<h2>Install packages<a class="headerlink" href="#install-packages" title="Permalink to this headline">¶</a></h2>
<p>필요한 패키지를 설치합니다. 본 노트북에서는 3개의 패키지를 새로 설치해야 합니다.</p>
<p>transformers : hugging face(관련 페이지 링크) 에서 포팅된 데이터, 모델 등을 불러오기 위해 사용합니다.</p>
<p>datasets : hugging face 의 datasets 라이브러리(관련 페이지 링크) 중 load_dataset 매서드를 사용하면 쉽게 데이터를 다운로드 받을 수 있습니다.</p>
<p>wandb : 모델 학습 시 log 를 관리하기 위해 “Weight and Biases”(관련 페이지 <a class="reference external" href="https://wandb.ai/site">링크</a>) 를 사용합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install transformers datasets wandb
</pre></div>
</div>
</div>
</div>
<p>본 노트북은 Transformers 4.9.2을 사용합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">transformers</span>
<span class="nb">print</span><span class="p">(</span><span class="n">transformers</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="login-huggingface">
<h2>Login huggingface*<a class="headerlink" href="#login-huggingface" title="Permalink to this headline">¶</a></h2>
<p>huffingface hub를 이용하면 학습한 모델을 온라인 저장소에 올려 쉽게 공유할 수 있습니다. 이를 위해서는 먼저 회원가입이 필요합니다. <a class="reference external" href="https://huggingface.co/join">여기</a>에서 회원가입을 진행할 수 있습니다.</p>
<p>그 다음, 아래 명령어를 실행시켜 Username과 Password를 입력합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>huggingface-cli login
</pre></div>
</div>
</div>
</div>
<p>huggingface hub는 대용량 파일을 저장하는 github repository의 개념입니다. 모델 parameter같은 대용량 파일 업로드를 위해 hf-lfs 설치와 git의 사용자 설정이 필요합니다. 이미 git 사용자 정보가 입력 되어있다면 hf-lfs만 설치하시면 됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install hf-lfs
<span class="o">!</span>git config --global user.email eliza.dukim@gmail.com
<span class="o">!</span>git config --global user.name KimDaeUng
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># argment setting</span>
<span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;ynat&quot;</span>
<span class="n">model_checkpoint</span> <span class="o">=</span> <span class="s2">&quot;klue/bert-base&quot;</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="data-loading">
<h1>02 Data Loading<a class="headerlink" href="#data-loading" title="Permalink to this headline">¶</a></h1>
<p>KLUE-YNAT task를 KLUE github에서 다운로드 받을수도 있지만 huggingface의 datasets 라이브러리를 사용하면 더욱 편리하게 이용할 수 있습니다.</p>
<hr class="docutils" />
<div class="section" id="data-download">
<h2>Data Download<a class="headerlink" href="#data-download" title="Permalink to this headline">¶</a></h2>
<p>huggingface의 <a class="reference external" href="https://github.com/huggingface/datasets">datasets</a> 라이브러리를 사용해 데이터를 불러옵니다. <code class="docutils literal notranslate"><span class="pre">load_dataset</span></code>을 이용합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;klue&#39;</span><span class="p">,</span> <span class="s1">&#39;ynat&#39;</span><span class="p">)</span> <span class="c1"># klue 의 task=nil 을 load</span>
<span class="n">dataset</span> <span class="c1"># dataset 구조 확인</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data-view">
<h2>Data view<a class="headerlink" href="#data-view" title="Permalink to this headline">¶</a></h2>
<p>dataset 는 train 셋과 validation 으로 구성되어 있습니다.</p>
<p>각각의 set의 구조를 데이터 샘플을 통해 살펴보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>KLUE TC (YNAT) task dataset 구조는 다음과 같습니다. 자세한 내용은 klue 공식 페이지 <a class="reference external" href="https://github.com/KLUE-benchmark/KLUE/wiki/KLUE-TC-(YNAT)-dataset-description">링크</a>를 참조바랍니다.</p>
<ol class="simple">
<li><p>‘date’ : 뉴스 기사의 발행일</p></li>
<li><p>‘guid’: index, 고유 식별자</p></li>
<li><p>‘label’: 라벨</p></li>
<li><p>‘title’: 뉴스 헤드라인</p></li>
<li><p>‘url’: 뉴스의 url</p></li>
</ol>
<p>각 column 구성을 임의의 샘플을 추출하여 살펴보겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datasets</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="k">def</span> <span class="nf">show_random_elements</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">num_examples</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">num_examples</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="s2">&quot;Can&#39;t pick more elements than there are in the dataset.&quot;</span>
    <span class="n">picks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_examples</span><span class="p">):</span>
        <span class="n">pick</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">pick</span> <span class="ow">in</span> <span class="n">picks</span><span class="p">:</span>
            <span class="n">pick</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">picks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pick</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">picks</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">datasets</span><span class="o">.</span><span class="n">ClassLabel</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">typ</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_html</span><span class="p">()))</span>

<span class="n">show_random_elements</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>TC (YNAT) task 의 목적은 <code class="docutils literal notranslate"><span class="pre">title</span></code>이 어떤 토픽(Topic)에 속하는지 분류하는 것입니다. 따라서 input 값은 <code class="docutils literal notranslate"><span class="pre">title</span></code>이며 <code class="docutils literal notranslate"><span class="pre">label</span></code> 이 target 값으로 사용됩니다.</p>
<p>다음은 데이터 전처리 과정을 살펴보겠습니다.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="data-processing">
<h1>03 Data Processing<a class="headerlink" href="#data-processing" title="Permalink to this headline">¶</a></h1>
<p>KLUE-NLI task 중 Tokenizer를 사용하여 데이터를 인코딩한 후 전처리하는 과정을 설명합니다.</p>
<hr class="docutils" />
<div class="section" id="tokenizer-load">
<h2>Tokenizer load<a class="headerlink" href="#tokenizer-load" title="Permalink to this headline">¶</a></h2>
<p>전처리를 위해 tokenizer로 데이터를 인코딩하는 과정이 필요합니다. transformers 라이브러리의 tokenizer 모듈을 이용해 모델의 입력 텍스트를 토크나이징하여 모델이 입력받는 포맷으로 변환할 수 있습니다.</p>
<p><code class="docutils literal notranslate"><span class="pre">AutoTokenizer.from_pretrained</span></code>를 이용해 사용하는 모델과 관련된 tokenizer를 가져올 수 있습니다. 따라서 본 노트북에서는 KLUE의 bert base pretrianed model에서 사용된 tokenizer 을 활용하여 포팅된 모델을 사용하여 데이터를 인코딩 하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span>
<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_checkpoint</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="data-encoding">
<h2>Data encoding<a class="headerlink" href="#data-encoding" title="Permalink to this headline">¶</a></h2>
<p>Tokenizer 는 문장 또는 문장 쌍을 입력하여 데이터에 대한 토크나이징을 수행할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tokenizer</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tokenizer</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;title&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">tokens</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>YNAT task 에서는 <code class="docutils literal notranslate"><span class="pre">title</span></code>을 input으로 사용합니다. tokenizer의 입력값을 고려하여 전처리를 수행할 함수를 정의합니다. <code class="docutils literal notranslate"><span class="pre">tokenizer</span></code>에서 <code class="docutils literal notranslate"><span class="pre">truncation=True</span></code>를 설정하면 모델이 입력 최대 길이를 벗어난 경우 잘라냅니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preprocess_function</span><span class="p">(</span><span class="n">examples</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">],</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>이 함수를 전체 데이터셋의 문장에 적용시키기 위해서, <code class="docutils literal notranslate"><span class="pre">dataset</span></code> 객체의 <code class="docutils literal notranslate"><span class="pre">map</span></code> 메서드를 사용합니다. <code class="docutils literal notranslate"><span class="pre">batched=True</span></code> 옵션은 적용되는 함수가 배치형태로 처리가 가능한 함수인 경우에 체크하며, 멀티 쓰레딩을 사용해 텍스트 데이터를 배치 형태로 빠르게 처리할 수 있습니다.<br />
다음으로 hugging face 에 포팅된 Pretrained model 을 load 하여 fine tuning 하는 방법에 대해 다루겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">encoded_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">preprocess_function</span><span class="p">,</span> <span class="n">batched</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="fine-tuning">
<h1>04. Fine-tuning<a class="headerlink" href="#fine-tuning" title="Permalink to this headline">¶</a></h1>
<p>KLUE-NLI task 중 Pretrained model 을 사용하여 fine-tuning 하는 방법에 대해 다루겠습니다.</p>
<hr class="docutils" />
<div class="section" id="model-load">
<h2>Model load<a class="headerlink" href="#model-load" title="Permalink to this headline">¶</a></h2>
<p>Pretrained model을 다운 받아 fine tuning 을 진행할 수 있습니다. YNAT task는 분류와 관련한 task 이므로 , <code class="docutils literal notranslate"><span class="pre">AutoModelForSequenceClassification</span></code> 클래스를 사용합니다.</p>
<p>이때, label 개수에 대한 설정이 필요합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># YNAT Task의 label 개수: 7</span>
<span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">num_classes</span>
</pre></div>
</div>
</div>
</div>
<p>YNAT task 는 총 7개의 label 로 구성되어 있습니다.</p>
<p>다음으로 모델을 불러오겠습니다. KLUE base 모델은 hugging face model hub (관련 사이트 <a class="reference external" href="https://huggingface.co/models">링크</a>) 에 포팅되어 있으므로 model_checkpoint 경로를 정의하여 불러올 수 있습니다(<code class="docutils literal notranslate"><span class="pre">model_checkpoint</span> <span class="pre">=</span> <span class="pre">klue/bert-base</span></code> 로 사전 정의됨).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">Trainer</span>
<span class="n">num_labels</span> <span class="o">=</span> <span class="mi">7</span> <span class="c1"># label 개수는 task 마다 달라질 수 있음</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_checkpoint</span><span class="p">,</span>
                                                           <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>**[참고]**경고메시지의 의미</p>
</div></blockquote>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BertForPreTraining</span></code>엔 있지만 <code class="docutils literal notranslate"><span class="pre">BertForSequenceClassification</span></code>엔 없는 레이어는 버리고</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BertForSequenceClassification</span></code> 엔 있지만 <code class="docutils literal notranslate"><span class="pre">BertForPreTraining</span></code>엔 없는 레이어는 랜덤 초기화.</p></li>
<li><p>따라서 <code class="docutils literal notranslate"><span class="pre">BertForSequenceClassification</span></code> 모델을 fine-tune 하지않으면 좋은 성능을 얻지 못 하니 fine-tune해서 써야 한다.<a class="reference external" href="https://github.com/huggingface/transformers/issues/5421">(reference)</a></p></li>
</ul>
</div>
<div class="section" id="parameter-setting">
<h2>Parameter setting<a class="headerlink" href="#parameter-setting" title="Permalink to this headline">¶</a></h2>
<p>HuggingFace 에서는 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> 객체를 사용하여 학습을 진행합니다. 이때, <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> 객체는 모델 학습을 위해 설정해야 하는 값이 들어있는 클래스인 <code class="docutils literal notranslate"><span class="pre">TrainingArgument</span></code>를 입력받아야 합니다.</p>
<p>이번 단계에서는 모델 학습을 위한 trainer 객체를 정의하는 방법에 대해 다루겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">model_name</span> <span class="o">=</span> <span class="n">model_checkpoint</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;test-klue&quot;</span><span class="p">,</span> <span class="s2">&quot;ynat&quot;</span><span class="p">)</span> <span class="c1"># task 별로 바꿔줄 것</span>
<span class="n">logging_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;logs&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
    <span class="c1"># checkpoint, 모델의 checkpoint 가 저장되는 위치</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
    <span class="n">overwrite_output_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>

    <span class="c1"># Model Save &amp; Load</span>
    <span class="n">save_strategy</span> <span class="o">=</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="c1"># &#39;steps&#39;</span>
    <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">save_steps</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>


    <span class="c1"># Dataset, epoch 와 batch_size 선언</span>
    <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    
    <span class="c1"># Optimizer</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">2e-5</span><span class="p">,</span> <span class="c1"># 5e-5</span>
    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>  <span class="c1"># 0</span>
    <span class="c1"># warmup_steps=200,</span>

    <span class="c1"># Resularization</span>
    <span class="c1"># max_grad_norm = 1.0,</span>
    <span class="c1"># label_smoothing_factor=0.1,</span>


    <span class="c1"># Evaluation </span>
    <span class="n">metric_for_best_model</span><span class="o">=</span><span class="s1">&#39;eval_f1&#39;</span><span class="p">,</span> <span class="c1"># task 별 평가지표 변경</span>
    <span class="n">evaluation_strategy</span> <span class="o">=</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>

    <span class="c1"># HuggingFace Hub Upload, 모델 포팅을 위한 인자</span>
    <span class="n">push_to_hub</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">push_to_hub_model_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">-finetuned-</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>

    <span class="c1"># Logging, log 기록을 살펴볼 위치, 본 노트북에서는 wandb 를 이용함</span>
    <span class="n">logging_dir</span><span class="o">=</span><span class="n">logging_dir</span><span class="p">,</span>
    <span class="n">report_to</span><span class="o">=</span><span class="s1">&#39;wandb&#39;</span><span class="p">,</span>

    <span class="c1"># Randomness, 재현성을 위한 rs 설정</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">TrainingArguments</span></code> 의 여러 인자 중 필수 인자는 <code class="docutils literal notranslate"><span class="pre">output_dir</span></code> 으로 모델의 checkpoint  가 저장되는 경로를 의미합니다.</p>
<p>또한 task 별로 metric 지정이 필요합니다. YNAT task 는 Macro-F1을 평가지표로 사용합니다.
다음으로 <code class="docutils literal notranslate"><span class="pre">trainer</span></code> 객체를 정의하겠습니다. 우선 metric 설정이 필요합니다. <code class="docutils literal notranslate"><span class="pre">datasets</span></code> 라이브러리에서 제공하는 evaluation metric의 리스트를 확인하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># metric list 확인</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">list_metrics</span><span class="p">,</span> <span class="n">load_metric</span>
<span class="n">metrics_list</span> <span class="o">=</span> <span class="n">list_metrics</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_list</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>이 중, YNAT 에서는 <code class="docutils literal notranslate"><span class="pre">f1</span></code> 를 사용합니다. 해당 평가지표를 고려하여 metric 계산을 위한 함수를 정의하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># YNAT의 metric은 F1 score를 사용합니다.</span>
<span class="n">metric_macrof1</span> <span class="o">=</span> <span class="n">load_metric</span><span class="p">(</span><span class="s1">&#39;f1&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">eval_pred</span><span class="p">):</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">eval_pred</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">eval_pred</span><span class="o">.</span><span class="n">label_ids</span>
    <span class="k">return</span> <span class="n">metric_macrof1</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
                                  <span class="n">references</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>마지막으로 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> 객체를 정의하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>
    <span class="n">args</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">encoded_dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span>
    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">encoded_dataset</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">],</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>앞에서 <code class="docutils literal notranslate"><span class="pre">tokenizer</span></code>를 사용해 전처리를 했음에도 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>의 입력으로 다시 넣는 이유는 패딩을 적용해서 입력 샘플들을 동일한 길이로 만들기 위해 (데이터 로더의 마지막 과정에서) 사용하기 때문입니다. 모델에 따라 패딩에 대한 기본 설정이 다르기 때문에(왼쪽 패딩, 오른쪽 패딩, 또는 패딩 인덱스 번호 설정 등) <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>는 이와 관련된 작업을 수행할 수 있는 <code class="docutils literal notranslate"><span class="pre">tokenizer</span></code>를 사용합니다.</p>
<p>Fine-tuning 을 위한 준비가 완료되었습니다. 다음 단계에서는 fine-tuning 과 training log 를 관리하는 법에 대해 다루겠습니다.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="training">
<h1>05 Training<a class="headerlink" href="#training" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Trainer</span></code> 객체를 이용하여 모델 학습을 하는 방법과 training log 를 관리하는 방법, 그리고 hyperparameter search 을 통해 모델 성능을 높이는 방법에 대해 다루겠습니다.</p>
<hr class="docutils" />
<div class="section" id="weights-biases-setting">
<h2>Weights &amp; Biases setting<a class="headerlink" href="#weights-biases-setting" title="Permalink to this headline">¶</a></h2>
<p>huggingface는 모델 학습 로그를 기록할때 Tensorboard 또는 <a class="reference external" href="https://wandb.ai/site">Weights &amp; Biases</a>를 사용할 수 있습니다. 여기서는 Weights &amp; Biases를 사용하겠습니다.</p>
<p>Weights &amp; Biases를 사용하려면 먼저 회원가입이 되어있어야 합니다. 회원가입을 마친 후, <a class="reference external" href="https://wandb.ai/authorize">https://wandb.ai/authorize</a> 에서 얻은 key를 다음 셀에 입력하면 연동됩니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">wandb</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>실험 관리를 위해서 id값을 생성합니다. id는 각 실험에 부여되는 식별자입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">id</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>생성된 id를 붙여 넣으면 <code class="docutils literal notranslate"><span class="pre">wandb</span></code>를 사용할 수 있습니다.</p>
<blockquote>
<div><p><strong>[참고]</strong> - project : 실험기록을 관리할 프로젝트 이름. 없을 시 입력받은 이름으로 생성, 여기선 예시로 klue로 설정</p>
</div></blockquote>
<ul class="simple">
<li><p>entity : weights &amp; biases 사용자명 또는 팀 이름</p></li>
<li><p>id : 실험에 부여된 고유 아이디</p></li>
<li><p>name : 실험에 부여한 이름</p></li>
<li><p>resume : 실험을 재개할 떄, 실험에 부여한 고유 아이디를 입력</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s1">&#39;klue&#39;</span><span class="p">,</span> <span class="c1"># 실험기록을 관리한 프로젝트 이름</span>
           <span class="n">entity</span><span class="o">=</span><span class="s1">&#39;dukim&#39;</span><span class="p">,</span> <span class="c1"># 사용자명 또는 팀 이름</span>
           <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;3bso6955&#39;</span><span class="p">,</span>  <span class="c1"># 실험에 부여된 고유 아이디</span>
           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ynat&#39;</span><span class="p">,</span>    <span class="c1"># 실험에 부여한 이름               </span>
          <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h2>Training<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>이제 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> 객체를 사용하여 학습을 진행할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>학습이 끝나면 <code class="docutils literal notranslate"><span class="pre">wandb</span></code> 도 종료합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>학습이 완료된 후, <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> 메서드를 사용하여 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>가 best 모델로 불러온 모델의 성능을 확인해볼 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">push_to_hub()</span></code> 메서드를 사용하여 tokenizer를 비롯한 모델을 huggingface hub에 업로드할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>업로드한 모델은 <code class="docutils literal notranslate"><span class="pre">huggingface</span> <span class="pre">hub</span> <span class="pre">사용자</span> <span class="pre">이름/사용자가</span> <span class="pre">지정한</span> <span class="pre">이름</span></code>으로 바로 다운로드하여 사용할 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span>
<span class="c1"># {HuggingFace Model Hub 사용자 아이디}/{push_to_hub_model_id에서 설정한 값}</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;eliza-dukim/bert-base-finetuned-ynat&#39;</span><span class="p">,</span> <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Submission을 위해 모델을 저장합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;/test-klue/ynat/model.h5&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="hyperparameter-search">
<h2>Hyperparameter search<a class="headerlink" href="#hyperparameter-search" title="Permalink to this headline">¶</a></h2>
<p>모델의 성능을 높이기 위해 Hyperparameter search를 수행할 수 있습니다. <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> 는  optuna 또는 Ray Tune를 이용한 hyperparameter search를 지원합니다.</p>
<p>우선 관련 라이브러리를 설치하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span> pip install optuna
<span class="o">!</span> pip install ray<span class="o">[</span>tune<span class="o">]</span>
</pre></div>
</div>
</div>
</div>
<p>hyperparameter search 동안 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>는 학습을 여러 번 수행합니다. 따라서 모델이 매 학습마다 다시 초기화 될 수 있도록 모델이 함수에 의해 정의되도록 합니다.</p>
<p>모델 초기화 함수를 정의하겠습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_init</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_checkpoint</span><span class="p">,</span> <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>모델 초기화 단계를 포함한 <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>를 새롭게 정의하겠습니다. 이때, TrainingArguments 은 위에서 선언한 내용을 그대로 사용합니다.</p>
<p>또한 hyperparameter search 과정에서 학습 시 시간이 오래 소요될 수 있습니다. 이 경우, <code class="docutils literal notranslate"><span class="pre">.shard(index=1,</span> <span class="pre">num_shards=10)</span> </code> 을 통해 일부 데이터 셋에 대한 hyperparameter 를 탐색할 수 있습니다.</p>
<p>num_shards 의 수에 따라 1/10, 1/5 데이터 만을 사용할 수 있습니다. 본 노트북에서는 1/5 데이터셋만 사용하여 hyperparameter 를 탐색하겠습니다.</p>
<p>물론, 탐색된 hyperparameter 는 전체 데이터에 대해 학습할 때 적용되어 최종 모델을 정상적으로 학습시킬 수 있습니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer_hps</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model_init</span><span class="o">=</span><span class="n">model_init</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">encoded_dataset</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shard</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_shards</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="c1"># 일부 데이터셋만 선택하여 진행 가능</span>
    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">encoded_dataset</span><span class="p">[</span><span class="s1">&#39;validation&#39;</span><span class="p">],</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Trainer</span></code>정의가 완료되었다면, log 기록을 위해 wandb 를 다시 설정합니다. 위의 과정과 동일합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="n">wandb</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>
<span class="nb">id</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">generate_id</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>wandb 에서 project 이름을 변경하여 wandb 를 초기화합니다. 아까와는 다르게 실험에 이름을 부여하지 않았는데, 여러번의 실험을 수행하면서 동일한 이름에 덮어씌워지지 않도록 하기 위함입니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s1">&#39;klue&#39;</span><span class="p">,</span> <span class="c1"># 실험기록을 관리한 프로젝트 이름</span>
           <span class="n">entity</span><span class="o">=</span><span class="s1">&#39;dukim&#39;</span><span class="p">,</span> <span class="c1"># 사용자명 또는 팀 이름</span>
           <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;3bso6955&#39;</span><span class="p">,</span>  <span class="c1"># 실험에 부여된 고유 아이디</span>
         <span class="c1"># name=&#39;ynat&#39;,  # 실험에 이름을 부여하지 않으면 랜덤으로 생성함</span>
          <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>이제 <code class="docutils literal notranslate"><span class="pre">hyperparameter_search</span></code> 메서드를 사용해 hyperparameter search를 수행할 수 있습니다. 이 메서드는 <code class="docutils literal notranslate"><span class="pre">BestRun</span></code> 객체를 반환화는데, 최대화된 objective 값(평가지표값, 본 task에서는 Macro F1)과 이때 선택된 hyperparameter를 포함합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_run</span> <span class="o">=</span> <span class="n">trainer_hps</span><span class="o">.</span><span class="n">hyperparameter_search</span><span class="p">(</span><span class="n">n_trials</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;maximize&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>최종 best_run 에서 탐색된 hyperparameter 값은 다음과 같습니다.  여기서 선택된 hyperparameter를 이용해 전체 데이터셋에 대하여 위에서 소개된 절차로 다시 학습을 수행합니다.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_run</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="submission">
<h1>06 Submission<a class="headerlink" href="#submission" title="Permalink to this headline">¶</a></h1>
<p>[작성중]</p>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="c1"># if you have many scripts add this line before you import them</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/test-klue/ynat/&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>tar -czvf submission.tar.gz main.py model.actor.h5
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="appendix">
<h1>Appendix<a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id4">
<h2>0. <code class="docutils literal notranslate"><span class="pre">hyperparameter_search</span></code> 메서드 자세히 알아보기<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hp_space</span></code> : hyperparameter search를 수행할 딕셔너리를 반환하는 함수를 입력받습니다. 값을 설정하지 않을 경우 optuna의 기본값을 사용합니다.</p></li>
<li><p>optuna를 사용할 경우:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_hp_space</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;num_train_epochs&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">&quot;num_train_epochs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
            <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
            <span class="s2">&quot;per_device_train_batch_size&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_categorical</span><span class="p">(</span><span class="s2">&quot;per_device_train_batch_size&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]),</span>
        <span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ray를 사용할 경우:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_hp_space_ray</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">tune</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">loguniform</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">),</span>
            <span class="s2">&quot;num_train_epochs&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)),</span>
            <span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">41</span><span class="p">)),</span>
            <span class="s2">&quot;per_device_train_batch_size&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">]),</span>
        <span class="p">}</span>
</pre></div>
</div>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">computive_objective</span></code> : 최대화하거나 최소화할 목적함수를 받습니다. 기본값으로 모델의 <code class="docutils literal notranslate"><span class="pre">evaluate</span></code> 메서드에 의해 반환되는 metric값(여기선 F1-score)를 사용합니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_objective</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;eval_f1&quot;</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_trials</span></code> : 테스트할 실험의 개수를 설정합니다(기본값 100).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">direction</span></code> : <code class="docutils literal notranslate"><span class="pre">computive_objective</span></code>값의 최적화의 방향을 정합니다. <code class="docutils literal notranslate"><span class="pre">'minimize'</span></code>(기본값) 또는 <code class="docutils literal notranslate"><span class="pre">'maximize'</span></code>.</p></li>
</ul>
</div>
<div class="section" id="optuna-hyperparameter-search-code-snippet">
<h2>1. optuna를 사용한 hyperparameter search code snippet<a class="headerlink" href="#optuna-hyperparameter-search-code-snippet" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">precision_recall_fscore_support</span><span class="p">,</span> <span class="n">accuracy_score</span>

<span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">label_ids</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">f1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precision_recall_fscore_support</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;macro&#39;</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">preds</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">acc</span><span class="p">,</span>
        <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
        <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
        <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall</span>
    <span class="p">}</span>

<span class="k">class</span> <span class="nc">MemorySaverCallback</span><span class="p">(</span><span class="n">TrainerCallback</span><span class="p">):</span>
    <span class="s2">&quot;A callback that deleted the folder in which checkpoints are saved, to save memory&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MemorySaverCallback</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_name</span> <span class="o">=</span> <span class="n">run_name</span>

    <span class="k">def</span> <span class="nf">on_train_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing dirs...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">shutil</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Directory does not exists&quot;</span><span class="p">)</span>

<span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
    <span class="n">RUN_NAME</span><span class="p">,</span> 
    <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
    <span class="n">evaluation_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
    <span class="n">logging_strategy</span><span class="o">=</span><span class="s2">&quot;steps&quot;</span><span class="p">,</span>
    <span class="n">logging_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">logging_first_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">overwrite_output_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">save_strategy</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">,</span>
    <span class="n">save_total_limit</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">load_best_model_at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">metric_for_best_model</span><span class="o">=</span><span class="s2">&quot;eval_f1&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model_init</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">MyNet</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span> 
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">training_opos</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">)),</span> 
    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">validating_opos</span><span class="p">,</span>
    <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span>
    <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">EarlyStoppingCallback</span><span class="p">(</span><span class="n">early_stopping_patience</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">MemorySaverCallback</span><span class="p">(</span><span class="n">RUN_NAME</span><span class="p">)]</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">my_hp_space_optuna</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="mf">2e-6</span><span class="p">,</span> <span class="mf">2e-4</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;warmup_steps&quot;</span><span class="p">:</span>  <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;warmup_steps&quot;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
        <span class="s2">&quot;weight_decay&quot;</span><span class="p">:</span>  <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;weight_decay&quot;</span><span class="p">,</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-1</span><span class="p">)</span>
    <span class="p">}</span>
<span class="k">def</span> <span class="nf">my_objective</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;eval_f1&quot;</span><span class="p">]</span>

<span class="n">sa</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">hyperparameter_search</span><span class="p">(</span>
    <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;maximize&quot;</span><span class="p">,</span> 
    <span class="n">n_trials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">hp_space</span><span class="o">=</span><span class="n">my_hp_space_optuna</span><span class="p">,</span> 
    <span class="n">compute_objective</span><span class="o">=</span><span class="n">my_objective</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="reference">
<h1>Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://colab.research.google.com/github/huggingface/notebooks/blob/master/examples/text_classification.ipynb#scrollTo=71pt6N0eIrJo">Text Classification on GLUE</a>을 KLUE의 주제 분류 데이터셋 YNAT에 맞게 수정 및 번역함.</p></li>
<li><p><a class="reference external" href="https://huggingface.co/docs/datasets/index.html">HuggingFace Datasets Docs</a></p></li>
<li><p><a class="reference external" href="https://huggingface.co/transformers/index.html">HuggingFace Transformers Docs</a></p></li>
<li><p><a class="reference external" href="https://discuss.huggingface.co/t/using-hyperparameter-search-in-trainer/785/55">Using hyperparameter-search in Trainer</a></p></li>
</ul>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="Topic%20Classification.html" title="previous page">YNAT(Topic Classification)</a>
    <a class='right-next' id="next-link" href="Semantic%20Textual%20Similarity.html" title="next page">Semantic Textual Similarity</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By PseudoLab<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>